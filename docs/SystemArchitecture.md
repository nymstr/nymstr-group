# System Architecture

This document provides a high-level overview of the **nymstr-groupd** server, detailing its core components, data flows, and technology stack.

## 1. Architecture Diagram

```text
    +-------------------+     JSON Actions     +-------------------+
    |    Client App     |--------------------->|   nymstr-groupd   |
    +-------------------+                      +---------+---------+
                                                     |
  +---------------+  +-----------+  +----------+  +-------------+
  | Configuration |  | LogConfig |  | DbUtils  |  | CryptoUtils |
  +-------+-------+  +-----+-----+  +-----+----+  +------+------+ 
          |               |              |              |     
          v               v              v              v     
    (read ENV vars)  (init logs)   (SQLite DB)   (keys dir)  
                                                     |
                                              +------+------+
                                              | MixnetClient |
                                              +------+------+
                                                     |
                                              +------+------+
                                              | MessageUtils|
                                              +------+------+ 
                                                     |
       +---------------+            +----------------+----------------+
       |   SQLite DB   |<--reads--> |        Redis Pub/Sub           |
       +---------------+            +-------------------------------+
                                                     |
                                              JSON Replies
                                                     |
                                              +-------------------+
                                              |    Client App     |
                                              +-------------------+
```

## 2. Component Overview

### main.rs
- **LogConfig**: Initializes logging (via `fern`) to both console and file.
- **DbUtils**: Sets up and migrates the SQLite database (via `sqlx`).
- **CryptoUtils**: Prepares encrypted key storage and password-based encryption (OpenSSL).
- **MixnetClient**: Builds and connects the Nym mixnet client (via `nym-sdk`).
- **RedisClient**: Connects to Redis for real-time pub/sub.
- **MessageUtils**: Orchestrates incoming messages, command handling, DB updates, and message broadcasting.


### LogConfig (`src/log_config.rs`)
- Configures timestamped, colored logging to stdout and also writes logs to a file.

### DbUtils (`src/db_utils.rs`)
- Manages a local SQLite database for:
  - `users` (username, publicKey, senderTag)
  - `groups`, `group_members`, `group_invites`
- Enables WAL mode and foreign key enforcement.

### CryptoUtils (`src/crypto_utils.rs`)
- Uses PGP (pgp crate 0.16) for:
  - Ed25519 keypair generation (~128-bit security)
  - PGP message signing and verification
- Uses OpenSSL for:
  - AES-256-GCM encryption of private keys
  - PBKDF2-HMAC-SHA256 for key derivation
- Stores encrypted private keys and public keys in the filesystem.

### MessageUtils (`src/message_utils.rs`)
- Receives reconstructed messages from the mixnet client.
- Parses JSON commands (`connect`, `createGroup`, `joinGroup`, `inviteGroup`, `approveGroup`, `sendGroup`).
- Updates group/user metadata in SQLite via `DbUtils`.
- Publishes and subscribes to group channels over Redis Pub/Sub for real-time message delivery.
- Signs and encapsulates responses back to clients via the mixnet.

## 3. Data Flow

1. **Client App** sends a JSON command over the Nym mixnet to `nymstr-groupd`.
2. `MessageUtils` parses and processes the command:
   - Validates user identity via sender tag lookup in SQLite.
   - Performs group or invite operations in the database.
   - For chat messages, publishes encrypted payloads to Redis channels.
3. `MessageUtils` sends JSON replies back to the client through the mixnet.
4. For active group members, background tasks subscribe to Redis channels and forward new messages over the mixnet.

## 4. Technology Stack

| Layer                 | Library / Tool            |
|-----------------------|---------------------------|
| Programming Language  | Rust (`edition = 2024`)   |
| Async Runtime         | Tokio                     |
| Mixnet Transport      | nym-sdk                   |
| Database              | SQLite (via `sqlx`)       |
| Pub/Sub Messaging     | Redis                     |
| Crypto Primitives     | PGP (Ed25519), OpenSSL (AES-GCM) |
| Key Derivation        | PBKDF2-HMAC-SHA256        |
| Configuration Loader  | Environment variables (std::env) |
| Logging               | fern (+ log, chrono)      |
| Serialization         | serde, serde_json         |

---

*Document generated by `docs/SystemArchitecture.md`*